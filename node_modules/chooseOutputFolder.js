var fs = require('fs'),
model = require('model');
 
function ChooseOutputFolder() {

	/*------------------------------------------------------------------
		Variables
	------------------------------------------------------------------*/
	var $ = model.$, el;
	var errorMsgStr;
	var outputDirPath;

	/*------------------------------------------------------------------
		Methods
	------------------------------------------------------------------*/
	function promptUserForOutputDir(msg) {
		$ = $ || model.$;

		var $el = $('.toolholder');
		errorMsgStr = msg;

		/*---------------
			Strings
		---------------*/
		var titleStr = "ShortHand repurposing tool";

		/*---------------
			Dom stuff
		---------------*/
		var appTitle = $('.appTitle');
		appTitle.html(titleStr);

		$el.empty();

		$el.load("../html/screens/chooseOutputDirectory.html", screenHtmlLoaded);

		/*---------------
			Listeners
		---------------*/

	}
	this.promptUserForOutputDir = promptUserForOutputDir;

	function screenHtmlLoaded() {

		var alertText = $('.changedOutputDirMsg');
		alertText.hide();

		var changeOkBtn = $('#changeOkButton');
		changeOkBtn.hide();

		outputDirPath = model.inputFolderPath + "_output";
		var changedOutputDir;

		var p1 = $("p")[0];
		var descripP = $('.toolholder').find(p1);
		var pTemplate = makeTemplate(descripP.html());
		descripP.html(pTemplate({shorthandDirectory: model.inputFolderPath, outputDirectory: outputDirPath}));

		var directoryBrowser = $("#folderBrowseInput");

		$("#folderBrowseButton").click(function () {
			directoryBrowser.trigger('click');
		});

		directoryBrowser.change(function(evt) {
			changedOutputDir = $(this).val();
			$('#okButton').hide();
			alertText.html('Ok the new output directory will be here: <span class="alertText">' + changedOutputDir + '</span>');
			alertText.show();
			changeOkBtn.show();
		});

		changeOkBtn.click(function () {
			model.stateMachine.publishStateChange(model.appStates.COPY_INPUT_INTO_OUTPUT, {input:model.inputFolderPath, output:changedOutputDir});
		});

		$('#okButton').click(function() {
			model.stateMachine.publishStateChange(model.appStates.COPY_INPUT_INTO_OUTPUT, {input:model.inputFolderPath, output:outputDirPath});
		});

	}

	/*------------------------------------------------------------------
		UTILITIES
	------------------------------------------------------------------*/
	function makeTemplate( str ) {
		return function ( data ) {
		var substitute = function ( match, substring ) {
			var result = '';
			eval( 'with ( data ) { result = ' + substring + ' ; }' );
			return result;
		};

		// return str.replace( /<%=([\s\S]+?)%>/g, substitute );
		return str.replace( /&lt;%=([\s\S]+?)%&gt;/g, substitute );
		};
	}

}
 
module.exports = new ChooseOutputFolder();