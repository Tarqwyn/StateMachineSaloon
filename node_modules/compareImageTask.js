var gm   = require('gm');
var async = require('async');

function CompareImageTask() {
    
    /*------------------------------------------------------------------
        Variables
    ------------------------------------------------------------------*/
    var equalityComparisons = [];
    var firstImage = null;
    var callback = null;

    /*------------------------------------------------------------------
        Methods
    ------------------------------------------------------------------*/
    function compare(imageToCompareAgainst, comparedImages, callbackFunc) {
        firstImage = imageToCompareAgainst;
        callback = callbackFunc;
        async.each(comparedImages, getEqualityValues, orderEqualityComparisons);
    }
    this.compare = compare;

    function getEqualityValues(imageToCompare, callback) {
        gm.compare(firstImage, imageToCompare, 0.11, function (err, isEqual, equality, raw) {
            // console.log("err = ", err);
            // console.log("isEqual = ", isEqual);
            // console.log("equality = ", equality);
            // console.log("raw = ", raw);
            equalityComparisons.push([imageToCompare, equality]);
            callback();
        });
    }
    this.getEqualityValues = getEqualityValues;

    function orderEqualityComparisons() {
        equalityComparisons.sort(function (a, b) {
            a = a[1];
            b = b[1];
            return a < b ? -1 : (a > b ? 1 : 0);
        });
        callback(equalityComparisons);
    }
    this.orderEqualityComparisons = orderEqualityComparisons;

}

module.exports = new CompareImageTask();