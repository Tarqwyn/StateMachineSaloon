var fs = require('fs'),
cheerio = require('cheerio'),
ncp = require('ncp'),
model;
 
function createBodyIncludeTask() {

	function go() {
		model = require('model');
		var originalHtmlFilePath = model.outputFolderPath + '/index.html';

		console.log('******************');
		console.log(originalHtmlFilePath);
		console.log('******************');

		readModuleFile(originalHtmlFilePath, function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var $ = cheerio.load(indexHtmlStr);

			var body = $('body');
			//added to fix an issue on the iPhone where the pictures become so large only a few pixles are shown on the screen;
			$('article.story').attr('id', 'story-body');
			if (body) {
				writeOutFile(model.outputFolderPath + '/body.inc', body.html());
				model.eventEmitter.emitEvent(model.emitterEvents.ARTICLE_TASK_COMPLETE);
			}

		});

	}
	this.go = go;

	function readModuleFile(path, callback) {
		try {
			var filename = require.resolve(path);
			fs.readFile(filename, 'utf8', callback);
		} catch (e) {
			callback(e);
		}
	}

	function writeOutFile(filePath, fileContents) {
		fs.writeFile(filePath, fileContents, function(fileWriteErr) {
			if (fileWriteErr) {
				console.log(fileWriteErr);
				model.stateMachine.publishStateChange(model.appStates.ERROR_STATE, "couldn't write to file: " + filePath);
			}
		});
	}

}

module.exports = new createBodyIncludeTask();