var fs = require('fs'),
cheerio = require('cheerio'),
model = require('model'),
ncp = require('ncp'),
gm = require('gm'),
compareImageTask = require('compareImageTask');
 
function ResponsiveImagesTask() {

	/*------------------------------------------------------------------
		Variables
	------------------------------------------------------------------*/
	var $ = model.$, el;
	// var taskFlow = [promptUser, sanityCheckFolder, lookForPicsInShHtml, makeSmallCopiesOfImages, compareImagesToSupplieddirectory, copyImagesIntoShorthand, addCss];
	var taskFlow = [promptUser, sanityCheckFolder, lookForPicsInShHtml, hackCopyImages, hackAddCss];
	var currentSubTask = 0;
	var currentfileCopying = 0;
	var picsFolderPath;
	var inputBtnMarkup = "<input id=\"folderBrowseInput\" class=\"folderBrowseInput\" type=\"file\" nwdirectory/>" +
						"<button id=\"folderBrowseButton\" class=\"folderBrowseButton\" type=\"submit\">" +
							"<img src=\"../assets/images/browseFolderIcon.png\">" +
							"<p style=\"display:inline-block;\">browse folders</p>" +
						"</button>";
	var fileSafety;
	var filesWithNoMatches = [];
	var filesToCopy = [];
	var shorthandFilesToRemove = {};
	var imagesToWorkWith = [];
	var imagesToCopy = [];
	var imagesToCopyAndResize = [];
	var smallCopiesIndex = 0;
	var basefileNameRegex = /_phonePortrait|_phoneLandscape|_tabletPortrait|_tabletLandscape|_largeDesktop|_extraLargeDesktop|.jpg|.jpeg|.gif|.png|.svg/gi;

	/*------------------------------------------------------------------
		Methods
	------------------------------------------------------------------*/
	function go() {

		$ = $ || model.$;

		var $el = $('.toolholder');

		/*---------------
			Strings
		---------------*/

		/*---------------
			Listeners
		---------------*/

		/*---------------
			Things to do:
			 * prompt the user for the location of the folder with the replacement images in
				* sanity check the folder that the user provides
				* copy the contents of the folder into the 'media/responsiveimgs' directory
				* replace the relevant style tags (media queries) in the index.html file
		---------------*/

		taskFlow[0]();

		console.log("TODO responsive images task: SVG images!!, replaces the image similarity methods with hacky hard coded values for rio, need to create a new image similarity task, perhaps using opencv and image keypoint matching, more info here: www.stackoverflow.com/questions/843972/image-comparison-fast-algorithm");

	}
	this.go = go;

	function promptUser() {

		var promptMarkup = "<div class=\"userPromptHolder\">" +
								"<p>" +
									"<b>Responsive images:</b>" +
								"</p>" +
								"<p>Please select the directory where the alternative responsive images are. The images should have the file name structure:" +
								"</br>" +
									"<b>ch_{chapterNumber}_{sectionNumber}_{image size label}.jpg</b>" +
								"</br>" +
								"</br>" +
								"Possible image labels are:" +
								"</br>" +
									"<b>phoneportrait</b> (0-399px)" +
								"</br>" +
									"<b>phonelandscape</b> (400-755px)" +
								"</br>" +
									"<b>tabletportrait</b> (756-1100px)" +
								"</br>" +
									"<b>tabletlandscape</b> (1101-1399px)" +
								"</br>" +
									"<b>largedesktop</b> (1400-1899px)" +
								"</br>" +
									"<b>extralargedesktop</b> (1900-infinity!px)" +
								"</br>" +
								"</br>" +
								"You can provide images at any size for these breakpoints, but it makes sense to keep them the same as the maximum break point value. An example directory might have the following files inside it:" +
								"</br>" +
								"ch_1_1_phoneportrait.jpg" +
								"</br>" +
								"ch_1_1_phonelandscape.jpg" +
								"</br>" +
								"ch_1_1_tabletportrait.jpg" +
								"</br>" +
								"ch_1_1_tabletlandscape.jpg" +
								"</br>" +
								"ch_1_1_largedesktop.jpg" +
								"</br>" +
								"ch_1_1_extralargedesktop.jpg" +
								"</br>" +
								"</p>" +
							"</div>";

		var alertHolder = $el.append(promptMarkup);
		var holder = $('.userPromptHolder');
		holder.append(inputBtnMarkup);

		$('#folderBrowseButton').on('click', browseBtnClickHandler);

		$("#folderBrowseInput").change(function(evt) {
			dirChangeHandler($(this).val());
		});
	}

	function browseBtnClickHandler() {
		$("#folderBrowseInput").trigger('click');
	}

	function dirChangeHandler(val) {
		picsFolderPath = val;
		subTaskComplete();
		$('#folderBrowseButton').off('click', browseBtnClickHandler);
	}

	function sanityCheckFolder() {
		//check to see if the pic names in the choosen folder match the images in the shorthand directory

		/*-------------------
			Message strings
		-------------------*/
		var noReadDirWarningMsg = "<p>" +
									"<b>Responsive images:</b>" +
								"</p>" +
								"<p class=\"alertText\">" +
									"Couldn't read the directory that you selected, please try again" +
								"</p>";
		var nofilesWarningMsg = "<p>" +
									"<b>Responsive images:</b>" +
								"</p>" +
								"<p class=\"alertText\">" +
									"There don't seem to be any files in the folder that you provided" +
								"</p>";
		var noSafeFilesWarningMsg = "<p>" +
									"<b>Responsive images:</b>" +
								"</p>" +
								"<p class=\"alertText\">" +
									"There doesn't seem to be any images in the folder that you provided of the correct format." +
									"</br>" +
									"Safe image formats are:" +
									"</br>" +
									".jpg" +
									"</br>" +
									".jpeg" +
									"</br>" +
									".gif" +
									"</br>" +
									".png" +
									"</br>" +
									".svg" +
								"</p>";

		var files;
		try {
			files = fs.readdirSync(picsFolderPath);
		}
		catch(e) {
			throwResetWarning(noReadDirWarningMsg);
			return e;
		}
		if (files.length > 0) {
			//loop through the files and check the safe list of file extensions
			fileSafety = returnSafeUnsafeFiles(files);
			if (fileSafety.safe.length) {
				//we have some safe files to work with
				subTaskComplete();
			}
			else {
				//there aren't any safe files in the directory
				throwResetWarning(noSafeFilesWarningMsg);
			}
		}
		else {
			throwResetWarning(nofilesWarningMsg);
		}
		
	}

	function lookForPicsInShorthand() {
		//fileSafety
		/*---------------
			Things to do:
			 * check the safe list of files with the files in the shorthand 
				output directory, if they match then you can copy the files
				over and edit the index.html files css witht he new image
				breakpoint info!
			 * if any of the images don't match then you can throw a warning
				to the user to prompt them to continue or choose another 
				folder
			 * check to see if there are any files in the unsafe list, if
				there are then you need to throw a warning to the user and
				pompt them to confirm that they want to continue or choose 
				another folder
		---------------*/
		var nofilesToCopyWarningMsg = "<p>" +
									"<b>Responsive images:</b>" +
								"</p>" +
								"<p class=\"alertText\">" +
									"There don't seem to be any files that I can copy over to shorthand. Please check that the images in shorthand and the new images in the folder you provided follow the same naming convention. You'll have to choose the directory again..." +
								"</p>";

		var nonMatchingfilesWarningMsg = "<p>" +
									"<b>Responsive images:</b>" +
								"</p>" +
								"<p class=\"alertText\">" +
									"There are some images in the folder you provided that don't match any of the files already in the shorthand output. if you'd like to continue anyway then click continue, or hit the 'browse folders' to select the directory again when you are ready. The files in question are:" +
								"</p>";

		var baseShorthandfileNames = {};
		
		var existingPics = fs.readdirSync(model.outputFolderPath + model.outputImagesPath);
		var a, arrLength = existingPics.length;
		for (a = 0; a < arrLength; a++) {
			var safeShorthandBaseFileName = existingPics[a].replace(basefileNameRegex, "").trim();
			if (!baseShorthandfileNames[safeShorthandBaseFileName]) {
				baseShorthandfileNames[safeShorthandBaseFileName] = 1;
			}
		}

		arrLength = fileSafety.safe.length;
		for (a = 0; a < arrLength; a++) {
			var safeFileNameWithoutLabel = fileSafety.safe[a].replace(basefileNameRegex, "").trim();
			if (baseShorthandfileNames[safeFileNameWithoutLabel]) {
				filesToCopy.push(fileSafety.safe[a]);
				if (!shorthandFilesToRemove[safeFileNameWithoutLabel]) {
					shorthandFilesToRemove[safeFileNameWithoutLabel] = 1;
				}
			}
			else {
				//can't find a matching file in the shorthand output folder
				filesWithNoMatches.push(fileSafety.safe[a]);
			}
		}

		if (filesToCopy.length) {
			if (!filesWithNoMatches.length) {
				subTaskComplete();
			}
			else{
				//there are some files in here without any matches in shorthand
				var filesWithNoMatchesStr = "";
				arrLength = filesWithNoMatches.length;
				for (a = 0; a < arrLength; a++) {
					filesWithNoMatchesStr += ("<p>" + filesWithNoMatches[a] + "</p>");
				}
				throwResetOrContinueWarning(nonMatchingfilesWarningMsg + filesWithNoMatchesStr);
			}
		}
		else {
			//no files to copy ... probably a discrepancy between the file names in the folder provided and the shorthand output directory
			throwResetWarning(nofilesToCopyWarningMsg);
		}

	}

	function lookForPicsInShHtml() {
		readModuleFile(model.outputFolderPath + '/index.html', function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var $ = cheerio.load(indexHtmlStr);
			var styleTags = $('style');
			//Loop through all the script tags in the page
			var a, arrLength = styleTags.length;
			for (a = 0; a < arrLength; a++) {
				if (styleTags[a]) {
					var styleTag = styleTags[a];
					if (styleTag.children.length == 1) {
						var styleTagStr = styleTag.children[0].data;
						if ((styleTagStr.indexOf("background-image: url(") + 1)) {
							var targetStyleObj = {};
							var firstdotIndex = styleTagStr.indexOf(".");
							var firstOpenBraceIndex = styleTagStr.indexOf(" {");
							
							targetStyleObj.className = styleTagStr.substring(firstdotIndex, firstOpenBraceIndex);

							var firstUrlStartIndex = styleTagStr.indexOf("background-image: url(") + 22;
							var firstUrlEndIndex =  styleTagStr.indexOf(")");
							var completeFileName = styleTagStr.substring(firstUrlStartIndex, firstUrlEndIndex);

							targetStyleObj.imageName = completeFileName.substring(completeFileName.lastIndexOf('/') + 1, completeFileName.length);

							imagesToWorkWith.push(targetStyleObj);

							//remove the style tag from the html file ... we'll add the css back into the common css file later
							$(styleTag).remove();
						}
					}
				}
			}

			// //write out the index string
			writeOutFile(model.outputFolderPath + '/index.html', $.html(), subTaskComplete);

		});
	}

	function makeSmallCopiesOfImages() {
		if (fs.existsSync("tmpGmImages")) {
			deleteNonEmpydirectory("tmpGmImages", tmpFolderRemoved);
		}
		else {
			tmpFolderRemoved();
		}

		function tmpFolderRemoved() {

			if (!fs.existsSync("tmpGmImages")) {
				fs.mkdirSync("tmpGmImages");
			}

			var a, arrLength = imagesToWorkWith.length;
			for (a = 0; a < arrLength; a++) {
				imagesToCopyAndResize.push({
					rootPath: model.outputFolderPath + model.outputImagesPath + "/",
					imageName: imagesToWorkWith[a].imageName
				});
			}

			var suppliedFileNamesArr = fs.readdirSync(picsFolderPath);
			suppliedFileNamesArr = tidyUpFilesArr(suppliedFileNamesArr);

			arrLength = suppliedFileNamesArr.length;
			console.log("arrLength = ", arrLength);
			for (a = 0; a < arrLength; a++) {
				imagesToCopyAndResize.push({
					rootPath: picsFolderPath + "/",
					imageName: suppliedFileNamesArr[a]
				});
			}

			makeSmallImage();
		}
	}

	function makeSmallImage() {
		gm(imagesToCopyAndResize[smallCopiesIndex].rootPath + imagesToCopyAndResize[smallCopiesIndex].imageName)
			.resize(150, 150, "!") //Add exclamation mark
			.autoOrient()
			.write('tmpGmImages/' + imagesToCopyAndResize[smallCopiesIndex].imageName, function (err) {
			if (!err) {
				smallCopiesIndex ++;
				if (smallCopiesIndex < imagesToCopyAndResize.length) {
					makeSmallImage();
				}
				else {
					subTaskComplete();
				}
			}
			else {
				console.log(err);
			}
		});
	}

	function compareImagesToSupplieddirectory() {
		/*
		* imagesToWorkWith:Array of objects
		* 	imagesToWorkWith[a]:
		* 		.className
		* 		.imageName
		*/

		$('.userPromptHolder').hide();
		////tmpGmImages

		var suppliedFileNamesArr = fs.readdirSync(picsFolderPath);
		suppliedFileNamesArr = tidyUpFilesArr(suppliedFileNamesArr);

		var fullOrigPathsArr = [];
		var a, arrLength = suppliedFileNamesArr.length;
		for (a = 0; a < arrLength; a++) {
			fullOrigPathsArr.push("tmpGmImages/" + suppliedFileNamesArr[a]);
		}

		//imagesToWorkWith
		var imageIndex = 0;
		compareImage();

		function compareImage() {
			if (imageIndex < imagesToWorkWith.length) {
				var imageToWorkWith = imagesToWorkWith[imageIndex];
				// console.log("imageToWorkWith = ", imageToWorkWith);

				var firstImagePath = "tmpGmImages/" + imageToWorkWith.imageName;
				
				compareImageTask.compare(firstImagePath, fullOrigPathsArr, function(equalityComparisons) {
					var topResult = equalityComparisons[0][0];
					if (topResult) {
						var fileName = topResult.substring(topResult.lastIndexOf("/") + 1, topResult.length);
						var fileNameWithoutImageLabel = fileName.substring(0, fileName.lastIndexOf("_"));

						//lets see which break point sizes are available for this image!
						var a, arrLength = model.imageLabels.length;
						for (a = 0; a < arrLength; a++) {

							var imageName = fileNameWithoutImageLabel + "_" + model.imageLabels[a] + ".jpg";
							var imagePath = picsFolderPath + "/" + imageName;
							if (fs.existsSync(imagePath)) {
								imageToWorkWith.replacementImgs = imageToWorkWith.replacementImgs || [];
								imageToWorkWith.replacementImgs.push({
									imageName: imageName,
									rootPath: picsFolderPath + "/",
									queryString: model.imageLabelMediaQueryLookup[model.imageLabels[a]]
								});
							}
						}
						
					}
					else {
						console.log("ERROR: I can't find a matching image for: " + firstImagePath + " in the supplied images directory");
					}
					console.log("image processed: " + imageIndex);
					imageIndex++;
					compareImage();
				});
			}
			else {
				subTaskComplete();
			}

		}
	}

	/********************************************************/
	/********************************************************/
	/********************************************************/
	function hackCopyImages() {
		//simply copy the whole directory contents
		var responsiveimgsFolderPath = model.outputFolderPath + model.outputImagesPath + "/responsiveimgs";
		if (!fs.existsSync(responsiveimgsFolderPath)) {
			// Do something
			fs.mkdirSync(responsiveimgsFolderPath);
		}
		currentfileCopying = 0;

		for (var a = 0; a < fileSafety.safe.length; a++) {
			imagesToCopy.push({
				imageName: fileSafety.safe[a],
				rootPath: picsFolderPath + "/"
			});
		}

		copyImageIntoShorthand();

	}

	function hackAddCss() {
		//var hackCssStr = "@media (min-width:1900px){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_phonelandscape.jpg)}}@media (max-width:399px){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_tabletportrait.jpg)}}@media (min-width:1900px){.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_phonelandscape.jpg)}}@media (max-width:399px){.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_tabletportrait.jpg)}}@media (min-width:1900px){.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_phonelandscape.jpg)}}@media (max-width:399px){.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_tabletportrait.jpg)}}@media (min-width:1900px){.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_phonelandscape.jpg)}}@media (max-width:399px){.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_tabletportrait.jpg)}}@media (min-width:1900px){.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_phonelandscape.jpg)}}@media (max-width:399px){.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_tabletportrait.jpg)}}@media (min-width:1900px){.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_phonelandscape.jpg)}}@media (max-width:399px){.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_tabletportrait.jpg)}}@media (min-width:1900px){.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_phonelandscape.jpg)}}@media (max-width:399px){.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_tabletportrait.jpg)}}@media (min-width:1900px){.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_phonelandscape.jpg)}}@media (max-width:399px){.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_tabletportrait.jpg)}}@media (min-width:1900px){.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_extralargedesktop.jpg)}}@media (min-width:1400px) and (max-width:1899px){.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_largedesktop.jpg)}}@media (min-width:400px) and (max-width:755px){.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_phonelandscape.jpg)}}@media (max-width:399px){.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_phoneportrait.jpg)}}@media (min-width:1101px) and (max-width:1399px){.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_tabletlandscape.jpg)}}@media (min-width:765px) and (max-width:1100px){.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_tabletportrait.jpg)}}";
		var hackCssStr = "@media (min-width:1900px) and (max-height:1900px){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_largedesktoplandscape.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_largedesktoplandscape.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_largedesktoplandscape.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_largedesktoplandscape.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_largedesktoplandscape.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_largedesktoplandscape.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_largedesktoplandscape.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_largedesktoplandscape.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_largedesktoplandscape.jpg)}}@media (min-width:1500px) and (max-width:1899px) and (orientation:landscape){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_desktoplandscape.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_desktoplandscape.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_desktoplandscape.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_desktoplandscape.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_desktoplandscape.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_desktoplandscape.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_desktoplandscape.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_desktoplandscape.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_desktoplandscape.jpg)}}@media (min-width:1000px) and (max-width:1499px) and (orientation:landscape){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_tabletlandscape.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_tabletlandscape.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_tabletlandscape.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_tabletlandscape.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_tabletlandscape.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_tabletlandscape.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_tabletlandscape.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_tabletlandscape.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_tabletlandscape.jpg)}}@media (min-width:666px) and (max-width:999px) and (orientation:landscape){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_smalltabletlandscape.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_smalltabletlandscape.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_smalltabletlandscape.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_smalltabletlandscape.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_smalltabletlandscape.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_smalltabletlandscape.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_smalltabletlandscape.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_smalltabletlandscape.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_smalltabletlandscape.jpg)}}@media (min-width:321px) and (max-width:665px) and (orientation:landscape){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_phonelandscape.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_phonelandscape.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_phonelandscape.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_phonelandscape.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_phonelandscape.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_phonelandscape.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_phonelandscape.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_phonelandscape.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_phonelandscape.jpg)}}@media (max-width:320px) and (orientation:landscape){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_smallphonelandscape.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_smallphonelandscape.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_smallphonelandscape.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_smallphonelandscape.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_smallphonelandscape.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_smallphonelandscape.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_smallphonelandscape.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_smallphonelandscape.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_smallphonelandscape.jpg)}}@media (min-width:1201px) and (min-height:1201px){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_largedesktopportrait.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_largedesktopportrait.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_largedesktopportrait.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_largedesktopportrait.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_largedesktopportrait.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_largedesktopportrait.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_largedesktopportrait.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_largedesktopportrait.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_largedesktopportrait.jpg)}}@media (min-width:901px) and (max-width:1200px) and (orientation:portrait){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_desktopportrait.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_desktopportrait.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_desktopportrait.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_desktopportrait.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_desktopportrait.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_desktopportrait.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_desktopportrait.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_desktopportrait.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_desktopportrait.jpg)}}@media (min-width:756px) and (max-width:900px) and (orientation:portrait){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_tabletportrait.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_tabletportrait.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_tabletportrait.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_tabletportrait.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_tabletportrait.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_tabletportrait.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_tabletportrait.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_tabletportrait.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_tabletportrait.jpg)}}@media (min-width:534px) and (max-width:755px) and (orientation:portrait){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_smalltabletportrait.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_smalltabletportrait.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_smalltabletportrait.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_smalltabletportrait.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_smalltabletportrait.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_smalltabletportrait.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_smalltabletportrait.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_smalltabletportrait.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_smalltabletportrait.jpg)}}@media (min-width:321px) and (max-width:533px) and (orientation:portrait){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_phoneportrait.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_phoneportrait.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_phoneportrait.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_phoneportrait.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_phoneportrait.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_phoneportrait.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_phoneportrait.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_phoneportrait.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_phoneportrait.jpg)}}@media (max-width:320px) and (orientation:portrait){.section-title-327{background-image:url(../../media/responsiveimgs/topimage_smallphoneportrait.jpg)}.section-text-over-media-528{background-image:url(../../media/responsiveimgs/ch1_1_smallphoneportrait.jpg)}.section-text-over-media-539{background-image:url(../../media/responsiveimgs/ch2_1_smallphoneportrait.jpg)}.section-text-over-media-506{background-image:url(../../media/responsiveimgs/ch2_2_smallphoneportrait.jpg)}.section-text-over-media-529{background-image:url(../../media/responsiveimgs/ch3_1_smallphoneportrait.jpg)}.section-text-over-media-509{background-image:url(../../media/responsiveimgs/ch3_2_smallphoneportrait.jpg)}.section-text-over-media-510{background-image:url(../../media/responsiveimgs/ch3_3_smallphoneportrait.jpg)}.section-text-over-media-524{background-image:url(../../media/responsiveimgs/ch4_1_smallphoneportrait.jpg)}.section-text-over-media-526{background-image:url(../../media/responsiveimgs/endimage_smallphoneportrait.jpg)}}";
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			cssStr += hackCssStr;

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}
	/********************************************************/
	/********************************************************/
	/********************************************************/

	function copyImagesIntoShorthand() {
		var responsiveimgsFolderPath = model.outputFolderPath + model.outputImagesPath + "/responsiveimgs";
		if (!fs.existsSync(responsiveimgsFolderPath)) {
			// Do something
			fs.mkdirSync(responsiveimgsFolderPath);
		}
		currentfileCopying = 0;
		
		var a, arrLength = imagesToWorkWith.length;
		for (a = 0; a < arrLength; a++) {
			var b, arrBLength = imagesToWorkWith[a].replacementImgs.length;
			for (b = 0; b < arrBLength; b++) {
				// console.log("imagesToWorkWith[a].replacementImgs[b].imageName = ", imagesToWorkWith[a].replacementImgs[b].imageName);
				imagesToCopy.push({
					imageName: imagesToWorkWith[a].replacementImgs[b].imageName,
					rootPath: imagesToWorkWith[a].replacementImgs[b].rootPath
				});
			}
		}


		copyImageIntoShorthand();
	}

	function copyImageIntoShorthand() {
		//imagesToWorkWith
		var responsiveimgsFolderPath = model.outputFolderPath + model.outputImagesPath + "/responsiveimgs";
		var imgName = imagesToCopy[currentfileCopying].imageName;

		var imgToCopyPath = imagesToCopy[currentfileCopying].rootPath + imgName;

		// console.log("responsiveimgsFolderPath = ", responsiveimgsFolderPath);
		// console.log("imgName = ", imgName);
		// console.log("imgToCopyPath = ", imgToCopyPath);

		ncp(imgToCopyPath, responsiveimgsFolderPath + "/" + imgName, function (err) {
			if (err && err[0].errno !== 47) {
				//error number 47 is a warning that the output directory already exists
				return console.error("copy error: ", err);
			}
			else {
				//file copied successfully
				currentfileCopying ++;
				if (currentfileCopying < imagesToCopy.length) {
					copyImageIntoShorthand();
				}
				else {
					subTaskComplete();
				}
			}
		});
	}

	function addCss() {
		//imagesToWorkWith
		//you can duplicated the media rule here as much as you like, it will get tidied up by the css parser task later on
		var responsiveimgsLocalFolderPath = "../.." + model.outputImagesPath + "/responsiveimgs";
		var additionalCssStr = "", a, arrLength = imagesToWorkWith.length;
		for (a = 0; a < arrLength; a++) {
			var b, arrBLength = imagesToWorkWith[a].replacementImgs.length;
			for (b = 0; b < arrBLength; b++) {
				var queryStr = imagesToWorkWith[a].replacementImgs[b].queryString;
				var fullImagePath = responsiveimgsLocalFolderPath + "/" + imagesToWorkWith[a].replacementImgs[b].imageName;
				additionalCssStr += (queryStr + " { ");
				additionalCssStr += (imagesToWorkWith[a].className + " { ");
				additionalCssStr += "background-image: url(";
				additionalCssStr += fullImagePath;
				additionalCssStr += "); } }";
				// console.log("-------------------");
				// console.log("queryStr = ", queryStr);
				// console.log("fullImagePath = ", fullImagePath);
				// console.log("-------------------");
			}
		}

		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			cssStr += additionalCssStr;

			console.log(additionalCssStr);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function deleteOldFiles() {
		var a, arrLength = filesToCopy.length, baseFileNames = [];
		for (a = 0; a < arrLength; a++) {
			var baseFileName = filesToCopy[a].replace(basefileNameRegex, "").trim();
			baseFileNames.push(baseFileName);
		}

		var oldShorthandFiles = fs.readdirSync(model.outputFolderPath + model.outputImagesPath);
		arrLength = oldShorthandFiles.length;
		for (a = 0; a < arrLength; a++) {
			var oldFileName = oldShorthandFiles[a];
			//ignore any directopries in there, only list the files
			var isDir = fs.lstatSync(model.outputFolderPath + model.outputImagesPath + "/" + oldFileName).isDirectory();
			if (!isDir) {
				var b, baseNameArrLength = baseFileNames.length;
				innerLoop:for (b = 0; b < baseNameArrLength; b++) {
					var isMatch = oldFileName.indexOf(baseFileNames[b]) + 1;
					if (isMatch) {
						fs.unlinkSync(model.outputFolderPath + model.outputImagesPath + "/" + oldFileName);
						break innerLoop;
					}
				}
			}
		}

		subTaskComplete();

	}

	function throwResetOrContinueWarning(warningMsg) {
		$('.userPromptHolder').empty();
		$('.userPromptHolder').append(warningMsg);

		var continueBtnMarkup = "<button id=\"continueButton\" class=\"folderBrowseButton\" type=\"submit\">" +
									"<p style=\"display:inline-block;\">continue</p>" +
								"</button>";

		$('.userPromptHolder').append(continueBtnMarkup);
		$('#continueButton').on('click', continueBtnClickHandler);
		
		resetFolderChioce();
	}

	function continueBtnClickHandler() {
		subTaskComplete();
	}

	function throwResetWarning(warningMsg) {
		$('.userPromptHolder').empty();
		$('.userPromptHolder').append(warningMsg);
		resetFolderChioce();
	}

	function resetFolderChioce() {
		currentSubTask = 0;

		var holder = $('.userPromptHolder');
		holder.append(inputBtnMarkup);

		$('#folderBrowseButton').on('click', browseBtnClickHandler);

		$("#folderBrowseInput").change(function(evt) {
			dirChangeHandler($(this).val());
		});
	}

	function returnSafeUnsafeFiles(files) {
		/*******************************************************************************
			checks the file extension against a safe list in the model and returns an 
			object with 2 properties called safe and unsafe both arrays of file names
		*******************************************************************************/
		var a, arrLength = files.length, safeFiles = [], unsafeFiles = [];
		for (a = 0; a < arrLength; a++) {
			var fileName = files[a];
			var indexOfDot = fileName.lastIndexOf(".");
			if (indexOfDot < 0) {
				continue;
			}
			var fileExstension = fileName.substring(indexOfDot, fileName.length);
			if (model.acceptableImageFormats[fileExstension]) {
				safeFiles.push(fileName);
			}
			else {
				if (!model.unacceptableIgnoreFormats[fileExstension]) {
					unsafeFiles.push(fileName);
				}
			}
		}
		return {safe:safeFiles, unsafe:unsafeFiles};
	}

	/*------------------------------------------------------------------
		UTILITIES
	------------------------------------------------------------------*/
	function deleteNonEmpydirectory(path, callback) {
		var deleteFolderRecursive = function(path) {
			if(fs.existsSync(path) ) {
				fs.readdirSync(path).forEach(function(file,index) {
					var curPath = path + "/" + file;
					if(fs.statSync(curPath).isDirectory()) { // recurse
						deleteFolderRecursive(curPath);
					} else { // delete file
						fs.unlinkSync(curPath);
						callback();
					}
				});
				fs.rmdirSync(path);
			}
		};
		deleteFolderRecursive(path);
	}

	function tidyUpFilesArr(arr) {
		var a, arrLength = arr.length;
		for (a = arrLength - 1; a >= 0; a--) {
			if (arr[a].match(".DS_Store")) {
				arr.splice(a, 1);
			}
		}
		return arr;
	}

	function subTaskComplete() {
		currentSubTask ++;
		if (currentSubTask < taskFlow.length) {
			taskFlow[currentSubTask]();
		}
		else {
			taskComplete();
		}
	}

	function taskComplete() {
		//remove the pop up window
		$('.userPromptHolder').remove();
		model.eventEmitter.emitEvent(model.emitterEvents.ARTICLE_TASK_COMPLETE);
	}

	function readModuleFile(path, callback) {
		try {
			var filename = require.resolve(path);
			fs.readFile(filename, 'utf8', callback);
		} catch (e) {
			callback(e);
		}
	}

	function writeOutFile(filePath, fileContents, callback) {
	fs.writeFile(filePath, fileContents, function(fileWriteErr) {
		if (fileWriteErr) {
			model.stateMachine.publishStateChange(model.appStates.ERROR_STATE, "couldn't write to file: " + filePath);
		}
		else {
			callback();
		}
	});
}

}
 
module.exports = new ResponsiveImagesTask();