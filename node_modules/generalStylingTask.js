var fs = require('fs'),
cheerio = require('cheerio'),
model = require('model'),
ncp = require('ncp');
 
function GeneralStylingTask() {

	/*------------------------------------------------------------------
		Variables
	------------------------------------------------------------------*/
	var taskFlow = [
		removeUppercaseFromHtml,
		removeUppercaseFromCss,
		changeFontStackAndLineHeightInHtml,
		changeFontStackandLineHeightInCss,
		changeTitleFontWeightInHtml,
		changeTitleFontSizes,
		changeSubTitleFontSizes,
		changeBodyFontSize,
		changeRightSideImgsTopPadding,
		removeNamesFromByline,
		removeRedBgColour,
		hideNavLinksAtLowRes,
		rmWidthAutoFromSmallHeaders,
		reduceHeaderSizeForSmallScreen,
		reduceHeaderSizeForEvenSmallerScreen,
		copyScrollDownIcon,
		addScrollDownIconToHtml,
		addScrollTextandIconStyles
	];
	var currentSubTask = 0;

	/*------------------------------------------------------------------
		Methods
	------------------------------------------------------------------*/
	function go() {

		taskFlow[0]();

		/*---------------
			Strings
		---------------*/

		/*---------------
			Listeners
		---------------*/
		// model.eventEmitter.emitEvent(model.emitterEvents.ARTICLE_TASK_COMPLETE);

		console.log("TODO general stying task: increase the top margin of the pictures on the right hand side so that they don't sit behind the top nav. Change the responsive sizes of the story sub title (done hacky in changeSubTitleFontSizes funcitno at the mo)");

	}
	this.go = go;

	function addScrollTextandIconStyles() {
		var targetStylesStr = ".story-scroll-text {color:#fff; font-size:15px; font-family:Helmet, Freesans, Helvetica, Arial, sans-serif; margin:2em auto 0 auto!important;} .story-scroll-icon {margin:8px auto 0 auto;}";
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			cssStr += targetStylesStr;

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function copyScrollDownIcon() {
		var scrollDownIconPath = model.localAssetsPath + model.imagesPath + "/scrolldownicon.png";
		var scrollDownIconOutputPath = model.outputFolderPath + "/static/img";
		
		//copy the istats lib into the new lib directory
		ncp(scrollDownIconPath, scrollDownIconOutputPath + "/scrolldownicon.png", function (err) {
			if (err) {
				return console.error("copy error: ", err);
			}
			subTaskComplete();
		});
	}

	function addScrollDownIconToHtml() {
		var iconMarkup =	"<p class=\"story-scroll-text\">Scroll down to continue</p>" +
							"<img class=\"story-scroll-icon\" src=\"./static/img/scrolldownicon.png\" alt=\"Scroll down to continue\" width=\"25\" height=\"25\">";
		var htmlFilePath = model.outputFolderPath + '/index.html';

		readModuleFile(htmlFilePath, function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var $ = cheerio.load(indexHtmlStr);
			var storyHeading = $('.story-heading');

			if (storyHeading) {
				storyHeading.after(iconMarkup);
			}

			writeOutFile(htmlFilePath, $.html(), subTaskComplete);

		});
	}

	function reduceHeaderSizeForEvenSmallerScreen() {
		var offendingMediaStr = "font-size:35px";
		var replaceWith = "font-size:30px";
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			cssStr = cssStr.strReplace(offendingMediaStr, replaceWith);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function reduceHeaderSizeForSmallScreen() {
		var offendingMediaStr = ".story-title{font-size:80px}";
		var replaceWith = ".story-title{font-size:60px}";
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			cssStr = cssStr.strReplace(offendingMediaStr, replaceWith);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function rmWidthAutoFromSmallHeaders() {
		var offendingMediaStr = "@media(max-width:755px){.section-title .text{width:auto}";
		var replaceWith = "@media(max-width:755px){";
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			cssStr = cssStr.strReplace(offendingMediaStr, replaceWith);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function hideNavLinksAtLowRes() {

		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			var offendingMediaQuery = "@media(max-width:755px){.section-navigation{display:none}}";
			var replaceWith = "@media(max-width:580px){.section-navigator{display:none !important}}";

			cssStr = cssStr.strReplace(offendingMediaQuery, replaceWith);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function removeRedBgColour() {

		readModuleFile(model.outputFolderPath + '/index.html', function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var offendingColour = "#7a0000";
			var replaceWith = "#ffffff";

			indexHtmlStr = indexHtmlStr.strReplace(offendingColour, replaceWith);

			writeOutFile(model.outputFolderPath + '/index.html', indexHtmlStr, subTaskComplete);

		});
	}

	function removeNamesFromByline() {
		readModuleFile(model.outputFolderPath + '/index.html', function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var $ = cheerio.load(indexHtmlStr);
			var bylineObj = $('.story-metadata');

			if (bylineObj) {
				var byLineStr = $(bylineObj[0]).html();
				var brIndex = byLineStr.indexOf("br>");
				if (brIndex + 1) {
					var dateStr = byLineStr.substring(brIndex + 3, byLineStr.length);
					$(bylineObj[0]).html(dateStr);

					$(bylineObj[0]).remove();

					writeOutFile(model.outputFolderPath + '/index.html', $.html(), subTaskComplete);
				}
				else {
					subTaskComplete();
				}
			}

		});
	}

	function removeUppercaseFromHtml() {
		readModuleFile(model.outputFolderPath + '/index.html', function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var upperCaseReplaceStr = "text-transform: uppercase;";
			indexHtmlStr = indexHtmlStr.strReplace(upperCaseReplaceStr);

			//write out the index string
			writeOutFile(model.outputFolderPath + '/index.html', indexHtmlStr, subTaskComplete);

		});
	}

	function removeUppercaseFromCss() {
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			var upperCaseReplaceStr = "text-transform:uppercase";
			cssStr = cssStr.strReplace(upperCaseReplaceStr);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function changeFontStackAndLineHeightInHtml() {
		//'gill_sans_mtregular', Arial, sans-serif
		//Helmet, Freesans, Helvetica, Arial, sans-serif
		readModuleFile(model.outputFolderPath + '/index.html', function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var fontStackReplaceStrs = [
				"'gill_sans_mtregular', Arial, sans-serif",
				"\"Gill Sans MT\", \"Gill Sans\", Arial, Helmet, Freesans, sans-serif"
			];

			var replaceWith = "Helmet, Freesans, Helvetica, Arial, sans-serif";
			
			var a;
			for (a = 0; a < fontStackReplaceStrs.length; a++) {
				indexHtmlStr = indexHtmlStr.strReplace(fontStackReplaceStrs[a], replaceWith, "gi");
			}

			var lineHeightReplaceStr = "line-height: .9;";
			replaceWith = "line-height: 1.05;" +
							"\n\tfont-weight: bold;" +
							"\n\tletter-spacing: -0.0425em;";
			indexHtmlStr = indexHtmlStr.strReplace(lineHeightReplaceStr, replaceWith);

			//padding: 30px 30px 0 30px;
			var paddingReplaceStr = "padding: 30px 30px 0 30px;";
			replaceWith = "padding: 30px 30px 0.3em 30px;";
			indexHtmlStr = indexHtmlStr.strReplace(paddingReplaceStr, replaceWith);

			//write out the index string
			writeOutFile(model.outputFolderPath + '/index.html', indexHtmlStr, subTaskComplete);

		});
	}

	function changeFontStackandLineHeightInCss() {
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			var fontStackReplaceStr1 = "'Open Sans',sans-serif";
			var fontStackReplaceStr2 = "'Open Sans'";
			var replaceWith = "Helmet, Freesans, Helvetica, Arial, sans-serif";
			
			cssStr = cssStr.strReplace(fontStackReplaceStr1, replaceWith);
			cssStr = cssStr.strReplace(fontStackReplaceStr2, replaceWith);

			var lineHeightReplaceStr = "line-height:1.5";
			replaceWith = "line-height:1.333333333";
			cssStr = cssStr.strReplace(lineHeightReplaceStr, replaceWith);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function changeTitleFontWeightInHtml() {
		readModuleFile(model.outputFolderPath + '/index.html', function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var regex = /.section-title .story-title {/g;
			var result = indexHtmlStr.match(regex);

			if (!result) {
				subTaskComplete();
				return;
			}

			var a, matchLength = result.length, indexOfClassArr = [], indexOfFontWeightArr = [];
			for (a = 0; a < matchLength; a++) {
				var prevIndex = indexOfClassArr[indexOfClassArr.length - 1] || 0;
				
				var matchIndex = indexHtmlStr.indexOf(".section-title .story-title {", prevIndex + 1);
				indexOfClassArr.unshift(matchIndex);

				var fontWeightMatch = indexHtmlStr.indexOf("font-weight: normal;", matchIndex);
				var closingBracketMatch = indexHtmlStr.indexOf("}", matchIndex);

				if (fontWeightMatch > matchIndex && fontWeightMatch < closingBracketMatch) {
					indexOfFontWeightArr.unshift(fontWeightMatch);
				}
			}

			for (a = 0; a < indexOfFontWeightArr.length; a++) {
				var beforeStr = indexHtmlStr.substring(0, indexOfFontWeightArr);
				var afterStr = indexHtmlStr.substring(indexOfFontWeightArr[a] + 20, indexHtmlStr.length);
				indexHtmlStr = beforeStr + "font-weight: bold;" + afterStr;
			}

			var addNewClass = ".story-heading {\n" +
									"\tfont-weight: normal !important;\n" +
								"}\n";
			var addClassBeforeString = ".section-title .story-metadata {";
			var indexBefore = indexHtmlStr.indexOf(addClassBeforeString);
			indexHtmlStr = indexHtmlStr.substring(0, indexBefore) + addNewClass + indexHtmlStr.substring(indexBefore, indexHtmlStr.length);


			//write out the index string
			writeOutFile(model.outputFolderPath + '/index.html', indexHtmlStr, subTaskComplete);

		});
	}

	function changeTitleFontSizes() {
		//blanket replace the values with ones we have choosen!!
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			var a, arrLength = model.titleFontSizeChanges.length;
			for (a = 0; a < arrLength; a++) {
				cssStr = cssStr.strReplace(model.titleFontSizeChanges[a].from, model.titleFontSizeChanges[a].to);
			}

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});

	}

	function changeSubTitleFontSizes() {
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			var replaceStr = "font-size:30px";
			var replaceWithStr = "font-size:40px";
			cssStr = cssStr.strReplace(replaceStr, replaceWithStr);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);
		});
	}

	function changeBodyFontSize() {

		var changeFontSizeStr = "font-size:20px";
		var targetFontSizeStr = "font-size:18px";
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			if (err) {
				console.log("err = ", err);
			}

			var regex = /.main-column{/g;
			var result = cssStr.match(regex);

			if (!result) {
				subTaskComplete();
				return;
			}
			var a, resultLength = result.length, currentMatchIndex = 0, matchIndexArr = [];
			for (a = 0; a < resultLength; a++) {
				var instanceOfClassName = cssStr.indexOf(".main-column{", currentMatchIndex);
				var nextInstanceOfbracket = cssStr.indexOf("}", instanceOfClassName);
				var indexOfFontSize = cssStr.indexOf(changeFontSizeStr, instanceOfClassName);
				if (indexOfFontSize < nextInstanceOfbracket) {
					matchIndexArr.unshift(indexOfFontSize);
				}
				currentMatchIndex = (instanceOfClassName + 1);
			}

			var arrLength = matchIndexArr.length;
			for (a = 0; a < arrLength; a++) {
				var beforeStr = cssStr.substring(0, matchIndexArr[a]);
				var afterStr = cssStr.substring(matchIndexArr[a] + changeFontSizeStr.length, cssStr.length);
				cssStr = beforeStr + targetFontSizeStr + afterStr;
			}
			
			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);

		});
	}

	function changeRightSideImgsTopPadding() {
		var cssFilePath = model.outputFolderPath + '/static/css/common.' + model.projectNumber + '.css';
		readModuleFile(cssFilePath, function (err, cssStr) {
			var replaceStr = "padding-top:40px";
			var replaceWithStr = "padding-top:60px";
			cssStr = cssStr.strReplace(replaceStr, replaceWithStr);

			//write out the index string
			writeOutFile(cssFilePath, cssStr, subTaskComplete);
		});
	}

	/*------------------------------------------------------------------
		UTILITIES
	------------------------------------------------------------------*/
	function subTaskComplete() {
		currentSubTask ++;
		if (currentSubTask < taskFlow.length) {
			taskFlow[currentSubTask]();
		}
		else {
			taskComplete();
		}
	}

	function taskComplete() {
		model.eventEmitter.emitEvent(model.emitterEvents.ARTICLE_TASK_COMPLETE);
	}

	function readModuleFile(path, callback) {
		try {
			var filename = require.resolve(path);
			fs.readFile(filename, 'utf8', callback);
		} catch (e) {
			callback(e);
		}
	}

	function writeOutFile(filePath, fileContents, callback) {
		fs.writeFile(filePath, fileContents, function(fileWriteErr) {
			if (fileWriteErr) {
				model.stateMachine.publishStateChange(model.appStates.ERROR_STATE, "couldn't remove google analytics fromt the project");
			}
			else {
				callback();
			}
		});
	}

}
 
module.exports = new GeneralStylingTask();