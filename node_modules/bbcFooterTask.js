var fs = require('fs'),
cheerio = require('cheerio'),
model = require('model'),
ncp = require('ncp');
 
function BbcFooterTask() {

	/*------------------------------------------------------------------
		Variables
	------------------------------------------------------------------*/
	var taskFlow = [addCss, addStyleTagToHTML, addBbcFooterMarkup];
	var currentSubTask = 0;

	/*------------------------------------------------------------------
		Methods
	------------------------------------------------------------------*/
	function go() {

		/*---------------
			Strings
		---------------*/

		/*---------------
			Listeners
		---------------*/

		/*---------------
			Things to do:
			 * add css classes to the main css file
			 	* hideMainHeader { height:0; visibility:hidden; }
			 * if the div with an id name of "header-{num}" exists then add some inline css to set the height to 0
			 * if the div with the class "section-navigation" exists then add the bbc logo and the 'NEWS' string next to it to the left hand side of the div
			 	* img src = http://static.bbci.co.uk/frameworks/barlesque/2.59.12/orb/4/img/bbc-blocks-light.png
			 	* img css = float:left; padding:10px;
		---------------*/

		taskFlow[0]();

		console.log("TODO: add the footer if one doesn't already exist in the page, style the rollover of all the anchor tags in the footer, remove the right side border on small screen sizes");

	}
	this.go = go;

	function addCss() {
		var footerCssPath = model.localAssetsPath + model.cssPath + "/bbcFooter.css";
		var outputDir = model.outputFolderPath + "/static/css";
		
		//copy the istats lib into the new lib directory
		ncp(footerCssPath, outputDir + "/bbcFooter.css", function (err) {
			if (err) {
				return console.error("copy error: ", err);
			}
			subTaskComplete();
		});
	}

	function addStyleTagToHTML() {
		var htmlfilePath = model.outputFolderPath + '/index.html';
		readModuleFile(htmlfilePath, function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var $ = cheerio.load(indexHtmlStr);
			var linkPossibilities = $('link');
			var a, arrLength = linkPossibilities.length, cssFound = false;
			for (a = 0; a < arrLength; a++) {
				var linkHref = linkPossibilities[a].attribs.href;
				if (linkHref === ("./static/css/common." + model.projectNumber + ".css")) {
					cssFound = true;
					var footerLinkMarkup = "<link href=\"./static/css/bbcFooter.css\" rel=\"stylesheet\" type=\"text/css\">\n";
					$(linkPossibilities[a]).before(footerLinkMarkup);
					writeOutFile(htmlfilePath, $.html(), subTaskComplete);
					break;
				}
			}
			if (!cssFound) {
				console.log("ERROR: I couldn't find the common css file!");
			}

		});
	}

	function addBbcFooterMarkup() {

		var bbcFooterMarkup = "<div id=\"orb-footer\" class=\"orb-footer orb-footer-grey orb-location-d\">" +
			"<aside role=\"complementary\">" +
				"<div id=\"orb-aside\" class=\"orb-nav-sec b-r b-g-p\">" +
					"<div class=\"orb-footer-inner\" role=\"navigation\">" +
						"<h2>" +
							"<img src=\"http://static.bbci.co.uk/frameworks/barlesque/2.59.12/orb/4/img/bbc-blocks-light.png\" width=\"84\" height=\"24\" alt=\"BBC navigation\">" +
						"</h2>" +
						"<div class=\"orb-footer-primary-links\">" +
							"<ul>" +
								"<li class=\"orb-nav-news orb-d\"> <a href=\"/news/\">News</a> " +
								"</li>" +
								"<li class=\"orb-nav-sport\"> <a href=\"/sport/\">Sport</a> " +
								"</li>" +
								"<li class=\"orb-nav-weather\"> <a href=\"/weather/\">Weather</a> " +
								"</li>" +
								"<li class=\"orb-nav-iplayer orb-d\"> <a href=\"/iplayer/\">iPlayer</a> " +
								"</li>" +
								"<li class=\"orb-nav-tv\"> <a href=\"/tv/\">TV</a> " +
								"</li>" +
								"<li class=\"orb-nav-radio\"> <a href=\"/radio/\">Radio</a> " +
								"</li>" +
								"<li class=\"orb-nav-cbbc\"> <a href=\"/cbbc/\">CBBC</a>"  +
								"</li>" +
								"<li class=\"orb-nav-cbeebies\"> <a href=\"/cbeebies/\">CBeebies</a> " +
								"</li>" +
								"<li class=\"orb-nav-comedy\"> <a href=\"/comedy/\">Comedy</a>"  +
								"</li>" +
								"<li class=\"orb-nav-food\"> <a href=\"/food/\">Food</a> " +
								"</li>" +
								"<li class=\"orb-nav-history\"> <a href=\"/history/\">History</a> " +
								"</li>" +
								"<li class=\"orb-nav-learning\"> <a href=\"/learning/\">Learning</a> " +
								"</li>" +
								"<li class=\"orb-nav-music\"> <a href=\"/music/\">Music</a> " +
								"</li>" +
								"<li class=\"orb-nav-science\"> <a href=\"/science/\">Science</a> " +
								"</li>" +
								"<li class=\"orb-nav-nature\"> <a href=\"/nature/\">Nature</a> " +
								"</li>" +
								"<li class=\"orb-nav-local\"> <a href=\"/local/\">Local</a> " +
								"</li>" +
								"<li class=\"orb-nav-travelnews\"> <a href=\"/travelnews/\">Travel News</a> " +
								'</li>' +
								"<li class=\"orb-nav-fullaz\"> <a href=\"/a-z/\">Full A-Z</a> " +
								"</li>" +
							"</ul>" +
						"</div>" +
					"</div>" +
				"</div>" +
			"</aside>" +
			"<footer role=\"contentinfo\">" +
				"<div id=\"orb-contentinfo\" class=\"orb-nav-sec b-r b-g-p\">" +
					"<div class=\"orb-footer-inner\">" +
						"<ul>" +
							"<li> <a href=\"/terms/\">Terms of Use</a> " +
							"</li>" +
							"<li> <a href=\"/aboutthebbc/\">About the BBC</a>"  +
							"</li>" +
							"<li> <a href=\"/privacy/\">Privacy Policy</a> " +
							"</li>" +
							"<li> <a href=\"/privacy/bbc-cookies-policy.shtml\">Cookies</a> " +
							"</li>" +
							"<li> <a href=\"/accessibility/\">Accessibility Help</a> " +
							"</li>" +
							"<li> <a href=\"/guidance/\">Parental Guidance</a> " +
							"</li>" +
							"<li> <a href=\"/contact/\">Contact the BBC</a> " +
							"</li>" +
						"</ul>" +
						"<small>" +
							"<span class=\"orb-hilight\">BBC Â© 2014 </span>The BBC is not responsible for the content of external sites. <a href=\"/help/web/links/\" class=\"orb-hilight\">Read about our approach to external linking.</a> " +
						"</small>" +
					"</div>" +
				"</div>" +
			"</footer>" +
		"</div>";

		var htmlfilePath = model.outputFolderPath + '/index.html';
		readModuleFile(htmlfilePath, function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var $ = cheerio.load(indexHtmlStr);
			var footerPossibilities = $('footer');
			if (footerPossibilities.length) {
				$(footerPossibilities[0]).before(bbcFooterMarkup);
				$(footerPossibilities[0]).remove();
			}
			else {
				//it doesn't look like theres a footer already in the document, add the new one in anyway
			}

			writeOutFile(htmlfilePath, $.html(), subTaskComplete);

		});

	}

	function subTaskComplete() {
		currentSubTask ++;
		if (currentSubTask < taskFlow.length) {
			taskFlow[currentSubTask]();
		}
		else {
			taskComplete();
		}
	}

	function taskComplete() {
		model.eventEmitter.emitEvent(model.emitterEvents.ARTICLE_TASK_COMPLETE);
	}

	/*------------------------------------------------------------------
		UTILITIES
	------------------------------------------------------------------*/
	function readModuleFile(path, callback) {
		try {
			var filename = require.resolve(path);
			fs.readFile(filename, 'utf8', callback);
		} catch (e) {
			callback(e);
		}
	}

	function writeOutFile(filePath, fileContents, callback) {
	fs.writeFile(filePath, fileContents, function(fileWriteErr) {
		if (fileWriteErr) {
			model.stateMachine.publishStateChange(model.appStates.ERROR_STATE, "couldn't write to file: " + filePath);
		}
		else {
			callback();
		}
	});
}

}
 
module.exports = new BbcFooterTask();