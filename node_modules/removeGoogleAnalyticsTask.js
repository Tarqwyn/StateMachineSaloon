var fs = require('fs'),
cheerio = require('cheerio'),
model;
 
function RemoveGoogleAnalyticsTask() {

	/*------------------------------------------------------------------
		Variables
	------------------------------------------------------------------*/

	/*------------------------------------------------------------------
		Methods
	------------------------------------------------------------------*/
	function go() {

		model = require('model');

		removeFromHtml();

		/*---------------
			Strings
		---------------*/

		/*---------------
			Listeners
		---------------*/
		// model.eventEmitter.emitEvent(model.emitterEvents.ARTICLE_TASK_COMPLETE);

	}
	this.go = go;

	function removeFromHtml() {

		readModuleFile(model.outputFolderPath + '/index.html', function (err, indexHtmlStr) {
			if (err) {
				console.log("err = ", err);
			}

			var $ = cheerio.load(indexHtmlStr);
			var scriptTags = $('script');
			//Loop through all the script tags in the page
			var a, arrLength = scriptTags.length;
			for (a = 0; a < arrLength; a++) {
				if (scriptTags[a]) {
					var scriptTag = scriptTags[a];
					if (scriptTag.children.length) {
						//loop through the children of the script tag
						var b, childLength = scriptTag.children.length;
						childLoop:for (b = 0; b < childLength; b++) {
							var dataStr = scriptTag.children[b].data;
							//check to see if the script tag contains the strings "GoogleAnalytics" or "ga("
							if (dataStr.indexOf('GoogleAnalytics') > -1 || dataStr.indexOf('ga(') > -1) {
								//remove the script tag from the page!
								$(scriptTag).remove();
								break childLoop;
							}
						}
					}
				}
			}

			//final index.html string output
			indexFileOutputStr = $.html();

			//write out the index string
			writeOutFile(model.outputFolderPath + '/index.html', indexFileOutputStr, removeFromJs);

		});
	}

	function removeFromJs() {

		var filePath = model.outputFolderPath + '/static/build/js/story.min.js';
		readModuleFile(filePath, function (err, storyJsStr) {
			var startGaIndex = storyJsStr.indexOf('(function(ga');
			if (startGaIndex < 0) {
				//can't find the google analytics instance, try with spaces incase the source has been beautified
				startGaIndex = storyJsStr.indexOf('(function (ga');
				if (startGaIndex < 0) {
					console.log("couldn't find any instances of google analytics in " + filePath);
					taskComplete();
				}
			}
			var endGaIndex = storyJsStr.indexOf('window.ga);', startGaIndex);

			var beforeGaCodeStr = storyJsStr.substring(0, startGaIndex);
			var afterGaCodeStr = storyJsStr.substring(endGaIndex + 11, storyJsStr.length);

			var storyJsOutputStr = beforeGaCodeStr + afterGaCodeStr;
			
			//write out the js file
			writeOutFile(filePath, storyJsOutputStr, taskComplete);
			
		});
	}

	function taskComplete() {
		model.eventEmitter.emitEvent(model.emitterEvents.ARTICLE_TASK_COMPLETE);
	}

	/*------------------------------------------------------------------
		UTILITIES
	------------------------------------------------------------------*/
	function readModuleFile(path, callback) {
		try {
			var filename = require.resolve(path);
			fs.readFile(filename, 'utf8', callback);
		} catch (e) {
			callback(e);
		}
	}

	function writeOutFile(filePath, fileContents, callback) {
		fs.writeFile(filePath, fileContents, function(fileWriteErr) {
			if (fileWriteErr) {
				model.stateMachine.publishStateChange(model.appStates.ERROR_STATE, "couldn't remove google analytics fromt the project");
			}
			else {
				callback();
			}
		});
	}

}
 
module.exports = new RemoveGoogleAnalyticsTask();