var eventEmitter = require('eventEmitter');
var instance = null;

function Model(){
	if(instance !== null){
		throw new Error("Cannot instantiate more than one Model, use Model.getInstance()");
	}
}

Model.prototype = {

		/*------------------------------------------------------------------
			Variables
		------------------------------------------------------------------*/
		eventEmitter: new eventEmitter(),
		isFullscreen:false,
		appTitleTemplate: undefined,
		inputFolderPath:undefined,
		outputFolderPath:undefined,
		projectNumber:undefined,
		setableOptionsArr:[],
		optionsObj:{},
		localAssetsPath: "./assets",
		jsLibPath: "/jsLib",
		jsPath: "/js",
		cssPath: "/css",
		imagesPath: "/images",
		outputImagesPath: '/media',
		acceptableImageFormats: {
			'.jpg': 1,
			'.jpeg': 1,
			'.gif': 1,
			'.png': 1,
			'.svg': 1
		},
		unacceptableIgnoreFormats: {
			'.DS_STORE': 1,
			'.DS_Store': 1,
			'.lock': 1,
			'.swp': 1,
			'.out': 1
		},
		imageLabels: [
			"extralargedesktop",
			"largedesktop",
			"phonelandscape",
			"phoneportrait",
			"tabletlandscape",
			"tabletportrait"
		],
		imageLabelMediaQueryLookup: {
			extralargedesktop: "@media (min-width: 1900px)",
			largedesktop: "@media (min-width: 1400px) and (max-width: 1899px)",
			phonelandscape: "@media (min-width: 400px) and (max-width: 755px)",
			phoneportrait: "@media (max-width: 399px)",
			tabletlandscape: "@media (min-width: 1101px) and (max-width: 1399px)",
			tabletportrait: "@media (min-width: 765px) and (max-width: 1100px)",
		},
		titleFontSizeChanges: [
			{
				from:'font-size:35px',
				to:'font-size:40px'
			},
			{
				from:'font-size:84px',
				to:'font-size:56px'
			},
			{
				from:'font-size:105px',
				to:'font-size:72px'
			},
			{
				from:'font-size:120px',
				to:'font-size:96px'
			}
		],

		//fs.readdirSync(localJsLibPath)
		
		/*------------------------------------------------------------------
			APP STATES
		------------------------------------------------------------------*/
		appStates: {
			IDLE:"idle",
			START:"start",
			ERROR_STATE:"gotoErrorState",
			CHECK_SHORTHAND_FOLDER:"checkShortHandFolder",
			CHOOSE_OUTPUT_DIRECTORY:"chooseOutputDirectory",
			COPY_INPUT_INTO_OUTPUT:"copyInputIntoOutput",
			DISPLAY_CHANGE_OPTIONS:"displaychangeOptions",
			PROCESS_ARTICLE:"processArticle",
		},

		/*------------------------------------------------------------------
			Event strings
		------------------------------------------------------------------*/
		emitterEvents: {
			ERROR:"error",
			ARTICLE_TASK_COMPLETE:"articleTaskComplete"
		},

		/*------------------------------------------------------------------
			State machine
		------------------------------------------------------------------*/
		stateMachine: (function() {

			this.addTransition = function(targetState, passableStates, targetFunction) {
				this.stateMap = this.stateMap || {};
				this.stateMap[targetState] = {
					passableStates:passableStates,
					targetFunction:targetFunction
				};
			};

			this.publishStateChange = function(stateName, args) {
				
				//model instance
				var model = Model.getInstance();

				//check to see if we can go to the propsed state
				var stateMapTransitionObj = this.stateMap[stateName];
				if (stateMapTransitionObj) {
					var statePass = false, a, arrLength = stateMapTransitionObj.passableStates.length;
					for (a = 0; a < arrLength; a++) {
						if (this.currentState === stateMapTransitionObj.passableStates[a] || stateMapTransitionObj.passableStates[a] == "*") {
							statePass = true;
							this.stateUpdated(stateName);
							stateMapTransitionObj.targetFunction(args);
							break;
						}
					}
					if (!statePass) {
						model.eventEmitter.emitEvent(model.emitterEvents.ERROR, ["You can't transition to state " + stateName + " from state " + this.currentState]);
					}
				}
				else {
					// this.throwError("AHHH! can't find the state that you are trying to transition to");
					model.eventEmitter.emitEvent(model.emitterEvents.ERROR, ["AHHH! can't find the state that you are trying to transition to"]);
				}
			};

			this.stateUpdated = function(newStateName) {
				this.currentState = newStateName;
			};

			this.currentState = "idle";

			return this;
		})(),

		/*------------------------------------------------------------------
			Methods
		------------------------------------------------------------------*/
		aMethod:function() {
			console.log("a method has been called");

		},

		////////////////
		/*------------------------------------------------------------------
			UTILITIES
		------------------------------------------------------------------*/
		makeTemplate:function(str) {
			return function ( data ) {
				var substitute = function ( match, substring ) {
					var result = '';
					eval( 'with ( data ) { result = ' + substring + ' ; }' );
					return result;
				};

				return str.replace( /<%=([\s\S]+?)%>/g, substitute );
			};
		}
		////////////////
	};
	
	Model.getInstance = function(){
		//Gets an instance of the singleton. It is better to use 
		if(instance === null){
			instance = new Model();
		}
		return instance;
	};

	module.exports = Model.getInstance();

	String.prototype.strReplace = function(needle, replacement) {return this.split(needle).join(replacement||"");};
